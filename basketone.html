<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Basket - imacx Shop (Debugged)</title>  <!-- Minimal libraries: Gun (P2P DB), Fuse (search), Razorpay -->  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>  <style>
    :root{--accent:#bfa046}
    body{font-family: 'Cursive',sans-serif;background:#fff;color:var(--accent);padding:16px}
    h2{color:var(--accent)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,textarea,select,button{font-family:inherit;padding:8px;border:1px solid var(--accent)}
    button{background:var(--accent);color:white;border-radius:6px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid var(--accent);padding:8px;text-align:center}
    img.small{width:60px;height:60px;object-fit:cover;border-radius:6px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    #orderOutput{white-space:pre-wrap;border:1px solid var(--accent);padding:12px;margin-top:12px}
    .muted{color:#666;font-size:0.9rem}
  </style></head>
<body>
  <h2>üõí Basket (Debugged)</h2>  <div class="row">
    <input id="searchBox" placeholder="Search items in basket (name, category, subcategory)" style="flex:1">
    <button id="clearBasketBtn">Clear Basket</button>
  </div>  <div id="basket-table" style="margin-top:12px"></div>  <h2>Shipping & Order</h2>
  <form id="shippingForm" onsubmit="return false;">
    <div class="row">
      <label style="flex:1">Recipient Name<br><input id="recipient" required></label>
      <label style="flex:1">Email<br><input id="email" type="email" required></label>
    </div>
    <div class="row">
      <label>Country Code<br><input id="countryCode" placeholder="+91"></label>
      <label>Phone<br><input id="phone" required></label>
      <label style="flex:1">Address<br><textarea id="address" rows="2" required></textarea></label>
    </div>
    <div class="row">
      <label>Area<br><input id="area"></label>
      <label>City<br><input id="city"></label>
      <label>State<br><input id="state"></label>
      <label>Country<br><input id="country"></label>
      <label>Zip<br><input id="zip"></label>
    </div><div class="controls" style="margin-top:8px">
  <button type="button" onclick="collectOrderDetails()">üìã Collect Order Info</button>
  <button type="button" onclick="generateOrderId()">üîê Generate Order ID</button>
  <button type="button" onclick="storeToAdmin()">üíæ Save Order</button>
  <button type="button" onclick="startPaymentFlow()">üí≥ Pay Now</button>
</div>

  </form>  <div id="orderOutput" aria-live="polite"></div>  <script>
  (function(){
    // --------------------
    // Config / Globals
    // --------------------
    // Replace peer with your own Gun peer(s) if available
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    const globalOrders = gun.get('imacx_orders');

    let orderId = '';
    let shipping = {};
    let newOrder = null;
    let total = 0;

    // Fuse search config
    const fuseOptions = { keys: ['name','category','subcategory'], threshold: 0.3 };
    let fuse = null;

    // --------------------
    // Helpers
    // --------------------
    function getBasket(){
      try { return JSON.parse(localStorage.getItem('basket')) || []; } catch(e){ return []; }
    }
    function saveBasket(b){ localStorage.setItem('basket', JSON.stringify(b)); if(fuse) fuse.setCollection(b); }

    function formatCurrency(n){ return '‚Çπ' + Number(n||0).toFixed(2); }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

    // --------------------
    // Render basket table
    // --------------------
    function renderBasket(filtered=null){
      const basket = filtered || getBasket();
      const container = document.getElementById('basket-table');
      if(!basket || basket.length === 0){
        container.innerHTML = '<p class="muted">Your basket is empty.</p>';
        updateOrderOutput();
        return;
      }

      total = 0;
      let html = '<table><thead><tr>' +
                 '<th>Image</th><th>Name</th><th>Unit</th><th>Qty</th><th>Subtotal</th><th>Category</th><th>Subcategory</th><th>Actions</th>' +
                 '</tr></thead><tbody>';

      basket.forEach((item, idx)=>{
        const qty = Number(item.quantity) || 0;
        const price = Number(item.price) || 0;
        const subtotal = qty * price;
        total += subtotal;
        html += `<tr data-idx="${idx}">` +
                `<td><img class="small" src="${escapeHtml(item.image||'')}" alt=""></td>` +
                `<td>${escapeHtml(item.name)}</td>` +
                `<td>${formatCurrency(price)}</td>` +
                `<td>` +
                  `<div style="display:flex;gap:6px;align-items:center;justify-content:center">` +
                    `<button class="qty-minus" data-idx="${idx}">-</button>` +
                    `<input class="qty-input" data-idx="${idx}" value="${qty}" style="width:60px;text-align:center">` +
                    `<button class="qty-plus" data-idx="${idx}">+</button>` +
                    `<button class="qty-update" data-idx="${idx}">Update</button>` +
                  `</div>` +
                `</td>` +
                `<td>${formatCurrency(subtotal)}</td>` +
                `<td>${escapeHtml(item.category||'')}</td>` +
                `<td>${escapeHtml(item.subcategory||'')}</td>` +
                `<td><button class="delete-btn" data-idx="${idx}">Delete</button></td>` +
                `</tr>`;
      });

      html += `</tbody><tfoot><tr><td colspan="4"><strong>Grand Total</strong></td><td colspan="4"><strong>${formatCurrency(total)}</strong></td></tr></tfoot></table>`;
      container.innerHTML = html;

      // attach listeners
      container.querySelectorAll('.qty-minus').forEach(b=>b.addEventListener('click', onQtyMinus));
      container.querySelectorAll('.qty-plus').forEach(b=>b.addEventListener('click', onQtyPlus));
      container.querySelectorAll('.qty-update').forEach(b=>b.addEventListener('click', onQtyUpdate));
      container.querySelectorAll('.qty-input').forEach(i=>i.addEventListener('change', onQtyInputChange));
      container.querySelectorAll('.delete-btn').forEach(b=>b.addEventListener('click', onDelete));

      updateOrderOutput();
    }

    // --------------------
    // Qty handlers
    // --------------------
    function onQtyMinus(e){ const idx = Number(e.currentTarget.dataset.idx); changeQuantity(idx, -1); }
    function onQtyPlus(e){ const idx = Number(e.currentTarget.dataset.idx); changeQuantity(idx, +1); }
    function onQtyUpdate(e){ const idx = Number(e.currentTarget.dataset.idx); const input = document.querySelector('.qty-input[data-idx="'+idx+'"]'); const val = Number(input.value||0); setQuantity(idx, val); }
    function onQtyInputChange(e){ const idx = Number(e.currentTarget.dataset.idx); const val = Number(e.currentTarget.value||0); if(val<0) e.currentTarget.value = 0; }

    function changeQuantity(idx, delta){
      const b = getBasket();
      if(!b[idx]) return;
      let q = Number(b[idx].quantity||0) + delta;
      if(q < 0) q = 0;
      b[idx].quantity = q;
      saveBasket(b);
      renderBasket();
    }

    function setQuantity(idx, val){
      const b = getBasket();
      if(!b[idx]) return;
      b[idx].quantity = Math.max(0, Number(val||0));
      saveBasket(b);
      renderBasket();
    }

    function onDelete(e){ const idx = Number(e.currentTarget.dataset.idx); deleteItem(idx); }

    function deleteItem(idx){
      const b = getBasket();
      if(!b[idx]) return;
      if(!confirm('Remove this item from basket?')) return;
      b.splice(idx,1);
      saveBasket(b);
      renderBasket();
    }

    // --------------------
    // Order collection / ID / saving
    // --------------------
    function collectOrderDetails(){
      const basket = getBasket();
      if(!basket || basket.length===0){ alert('Basket empty. Add items first.'); return; }

      shipping = {
        recipient: document.getElementById('recipient').value.trim(),
        email: document.getElementById('email').value.trim(),
        countryCode: document.getElementById('countryCode').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        address: document.getElementById('address').value.trim(),
        area: document.getElementById('area').value.trim(),
        city: document.getElementById('city').value.trim(),
        state: document.getElementById('state').value.trim(),
        country: document.getElementById('country').value.trim(),
        zip: document.getElementById('zip').value.trim()
      };

      if(!shipping.recipient || !shipping.email || !shipping.phone){ alert('Please fill recipient name, email and phone.'); return; }

      total = basket.reduce((acc,i)=>acc + (Number(i.price||0) * Number(i.quantity||0)), 0);

      updateOrderOutput();
      alert('Order details collected. Generate Order ID and Save Order when ready.');
    }

    function generateOrderId(){ orderId = 'IMX' + Math.random().toString(36).substr(2,9).toUpperCase(); updateOrderOutput(); alert('Order ID: ' + orderId); }

    function storeToAdmin(){
      const basket = getBasket();
      if(!basket || basket.length===0){ alert('Basket empty.'); return; }
      if(Object.keys(shipping).length === 0){ alert('Collect shipping info first.'); return; }
      if(!orderId) generateOrderId();

      total = basket.reduce((acc,i)=>acc + (Number(i.price||0) * Number(i.quantity||0)), 0);
      newOrder = {
        orderId,
        basket: JSON.parse(JSON.stringify(basket)),
        shipping: JSON.parse(JSON.stringify(shipping)),
        total,
        status: 'Order Created',
        timestamp: Date.now()
      };

      // Save by id and also add to set for global listing
      globalOrders.get(orderId).put(newOrder, ack => {
        if(ack && ack.err){ console.error('Gun put error', ack.err); alert('Error saving order to GunDB (see console)'); return; }

        // add to set for listing
        try{ globalOrders.set(newOrder); } catch(e){ console.warn('globalOrders.set failed', e); }

        // local backup
        const existing = JSON.parse(localStorage.getItem('admin_orders')||'[]'); existing.push(newOrder); localStorage.setItem('admin_orders', JSON.stringify(existing));

        updateOrderOutput();
        alert('‚úÖ Order saved to GunDB');
      });
    }

    // --------------------
    // Payment (Razorpay)
    // --------------------
    function startPaymentFlow(){
      const basket = getBasket();
      if(!basket || basket.length===0){ alert('Basket empty.'); return; }
      if(Object.keys(shipping).length === 0){ alert('Collect shipping info first.'); return; }
      if(!orderId) generateOrderId();

      total = basket.reduce((acc,i)=>acc + (Number(i.price||0) * Number(i.quantity||0)), 0);
      newOrder = { orderId, basket: JSON.parse(JSON.stringify(basket)), shipping: JSON.parse(JSON.stringify(shipping)), total, status:'Order Created', timestamp: Date.now() };

      // Save before payment
      globalOrders.get(orderId).put(newOrder);
      try{ globalOrders.set(newOrder); } catch(e){}

      const options = {
        key: 'rzp_live_ozWo08bXwqssx3', // replace with test key while testing
        amount: Math.round(total * 100),
        currency: 'INR',
        name: 'imacx Shop',
        description: `Order ID: ${orderId}`,
        notes: { orderId, grandTotal: formatCurrency(total) },
        handler: function(resp){
          try{
            alert('Payment complete: ' + resp.razorpay_payment_id);
            // Update status
            globalOrders.get(orderId).get('status').put('Payment Done');
            globalOrders.set(Object.assign({}, newOrder, { status: 'Payment Done' }));

            // save orderData locally
            const finalOrder = Object.assign({}, newOrder, { status: 'Payment Done', razorpay_payment_id: resp.razorpay_payment_id });
            localStorage.setItem('orderData', JSON.stringify(finalOrder));

            // clear basket
            localStorage.removeItem('basket');
            renderBasket();

            // redirect to thank you
            window.location.href = 'thankyou.html';
          } catch(err){ console.error('post-payment error', err); alert('Payment succeeded but post-processing failed. See console.'); }
        },
        prefill: { name: shipping.recipient || '', email: shipping.email || '', contact: (shipping.countryCode||'') + (shipping.phone||'') },
        theme: { color: '#bfa046' }
      };

      try{ new Razorpay(options).open(); } catch(err){ console.error('Razorpay open error', err); alert('Unable to open payment gateway.'); }
    }

    // --------------------
    // Order output UI
    // --------------------
    function updateOrderOutput(){
      const basket = getBasket();
      const out = { orderId, shipping, basket, total };
      document.getElementById('orderOutput').textContent = JSON.stringify(out, null, 2);
    }

    // --------------------
    // Search & Clear
    // --------------------
    document.getElementById('searchBox').addEventListener('input', function(e){
      const q = (e.target.value||'').trim();
      const items = getBasket();
      if(!q){ renderBasket(items); return; }
      if(!fuse){ fuse = new Fuse(items, fuseOptions); }
      const res = fuse.search(q).map(r=>r.item);
      renderBasket(res);
    });

    document.getElementById('clearBasketBtn').addEventListener('click', function(){
      if(!confirm('Clear entire basket?')) return;
      localStorage.removeItem('basket');
      renderBasket();
      if(fuse) fuse.setCollection([]);
    });

    // --------------------
    // Init
    // --------------------
    function init(){
      const items = getBasket();
      renderBasket(items);
      fuse = new Fuse(items, fuseOptions);
      updateOrderOutput();

      // Expose for debugging
      window._imacx = { getBasket, saveBasket, renderBasket, collectOrderDetails, generateOrderId, storeToAdmin, startPaymentFlow };
    }

    init();

  })();
  </script></body>
</html>
