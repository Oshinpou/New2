<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://checkout.razorpay.com; script-src 'self' https://checkout.razorpay.com https://cdn.jsdelivr.net https://gun-manhattan.herokuapp.com https://gundb-webrtc.herokuapp.com https://gun-us.herokuapp.com https://peer.walled.city; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' https://via.placeholder.com data:; connect-src 'self' ws://localhost:8765 https://gun-manhattan.herokuapp.com https://gundb-webrtc.herokuapp.com https://gun-us.herokuapp.com https://peer.walled.city;">
    <title>User Account Management</title>
    <script type="module" src="userdb.js" async></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&family=Lato:wght@300;400&display=swap');
        :root { --gold-gradient: linear-gradient(145deg, #b38728, #fcf6ba, #b38728); --gold-text-color: #d4af37; --dark-bg: #1a1a1a; --section-bg: #242424; --border-color: rgba(212, 175, 55, 0.3); --text-color: #f0f0f0; --input-bg: #333; --input-text-color: #fff; --danger-color: #ff4d4d; --danger-hover: #e60000; --success-color: #28a745; }
        body { font-family: 'Lato', Arial, sans-serif; background-color: var(--dark-bg); background-image: url('https://www.transparenttextures.com/patterns/dark-denim-3.png'); color: var(--text-color); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 40px auto; background-color: var(--section-bg); padding: 20px 40px; border-radius: 15px; border: 2px solid transparent; border-image: var(--gold-gradient) 1; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 25px rgba(212, 175, 55, 0.2); }
        h1, h2, h3 { font-family: 'Great Vibes', cursive; font-weight: normal; letter-spacing: 2px; text-align: center; background: var(--gold-gradient); -webkit-background-clip: text; background-clip: text; color: transparent; padding-bottom: 15px; margin-bottom: 30px; border-bottom: 1px solid; border-image: var(--gold-gradient) 1; }
        h1 { font-size: 4.5em; } h2 { font-size: 3.5em; margin-top: 40px; } h3 { font-size: 2.8em; margin-top: 25px; border-bottom: none; padding-bottom: 5px; } h4 { font-family: 'Lato', sans-serif; font-weight: 400; font-size:1.3em; color: var(--gold-text-color); margin-bottom: 5px; text-align: left; }
        .section, .sub-section { margin-bottom: 30px; padding: 25px; border-radius: 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); box-shadow: inset 0 0 15px rgba(0,0,0,0.5); }
        label { display: block; margin-bottom: 10px; font-weight: 300; color: var(--gold-text-color); font-size: 1.1em; }
        input[type="text"], input[type="email"], input[type="tel"], input[type="password"], input[type="number"], textarea { width: 100%; padding: 14px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 5px; box-sizing: border-box; background-color: var(--input-bg); color: var(--input-text-color); font-family: 'Lato', sans-serif; font-size: 1em; transition: all 0.3s ease-in-out; }
        input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus, input[type="password"]:focus, input[type="number"]:focus, textarea:focus { outline: none; border-color: var(--gold-text-color); box-shadow: 0 0 15px rgba(212, 175, 55, 0.5); }
        .input-group { display: flex; gap: 20px; } .input-group > div { flex: 1; }
        button { background: var(--gold-gradient); color: #1a1a1a; padding: 15px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1.2em; font-weight: bold; width: 100%; margin-top: 10px; transition: all 0.3s ease-in-out; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); position: relative; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4); }
        button:disabled { background: #555; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }
        .btn-danger { background: var(--danger-color); color: white; } .btn-danger:hover:not(:disabled) { background: var(--danger-hover); box-shadow: 0 6px 20px rgba(255, 77, 77, 0.4); }
        .btn-secondary { background-color: #555; color: white; border: 1px solid #777; } .btn-secondary:hover:not(:disabled) { background-color: #666; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4); }
        .btn-success { background-color: var(--success-color); color: white; } .btn-success:hover:not(:disabled) { background-color: #218838; }
        .message-output { padding: 15px; margin-top: 20px; border-radius: 5px; background-color: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: #ccc; text-align: center; font-style: italic; }
        .confirmation-group label { font-weight: 300; display: flex; align-items: center; gap: 15px; color: var(--text-color); margin-bottom: 15px; cursor: pointer; }
        .confirmation-group input[type="checkbox"] { appearance: none; width: 20px; height: 20px; border: 1px solid var(--gold-text-color); border-radius: 3px; cursor: pointer; position: relative; transition: all 0.2s; flex-shrink: 0; }
        .confirmation-group input[type="checkbox"]:checked { background: var(--gold-gradient); }
        .confirmation-group input[type="checkbox"]:checked::after { content: 'âœ”'; color: var(--dark-bg); position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 14px; font-weight: bold; }
        #account-data-note, .order-item, .product-card { border: 1px solid; border-image: var(--gold-gradient) 1; background: rgba(0,0,0,0.2); box-shadow: 0 4px 10px rgba(0,0,0,0.4); }
        .saved-products-container, .orders-container, .cart-items-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .product-card, .order-item { padding: 20px; flex-basis: calc(50% - 22px); border-radius: 10px; }
        .product-card img, .cart-item img { max-width: 100%; border-radius: 5px; border: 1px solid var(--border-color); margin-bottom: 15px; }
        .loading-spinner::after { content: ''; position: absolute; width: 16px; height: 16px; top: 50%; left: 50%; margin: -8px 0 0 -8px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }
        .notification-item, .activity-item { background: var(--input-bg); padding: 10px 15px; margin-bottom: 10px; border-left: 3px solid var(--gold-text-color); border-radius: 3px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        .notification-item span, .activity-item span { color: #aaa; font-size: 0.9em; }
        .chat-container { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        .chat-window { height: 250px; overflow-y: auto; padding: 15px; background: rgba(0,0,0,0.1); }
        .chat-message { margin-bottom: 15px; display: flex; flex-direction: column; }
        .chat-message.user { align-items: flex-end; } .chat-message.admin { align-items: flex-start; }
        .chat-message p { max-width: 70%; padding: 10px 15px; border-radius: 12px; margin: 0; word-wrap: break-word; }
        .chat-message.user p { background: var(--gold-text-color); color: var(--dark-bg); border-bottom-right-radius: 0; }
        .chat-message.admin p { background: #555; color: var(--text-color); border-bottom-left-radius: 0; }
        .chat-message p a { color: inherit; text-decoration: underline; }
        .chat-input-area { display: flex; border-top: 1px solid var(--border-color); }
        .chat-input-area textarea { border: none; border-radius: 0; margin-bottom: 0; resize: none; flex-grow: 1; }
        .chat-input-area button { width: auto; border-radius: 0; margin: 0; font-size: 1em; padding: 10px 15px; }
        .cart-item { flex-basis: 100%; display: flex; gap: 20px; align-items: center; padding: 15px;}
        .cart-item img { max-width: 100px; margin: 0; } .cart-item-details { flex-grow: 1; }
        .cart-total-section { text-align: right; margin-top: 20px; padding-top: 20px; border-top: 1px solid; border-image: var(--gold-gradient) 1;}
        .cart-total-section h3 { text-align: right; border: none; padding: 0; margin: 0 0 15px 0; }
        .checkout-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
        .checkout-modal-content { background-color: var(--section-bg); margin: 5% auto; padding: 30px; border: 1px solid; border-image: var(--gold-gradient) 1; width: 80%; max-width: 700px; border-radius: 15px; position: relative; }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .order-summary-table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        .order-summary-table td { padding: 10px; border-bottom: 1px solid var(--border-color); }
        .order-summary-table tr:last-child td { border-bottom: none; }
        .order-summary-table td:last-child { text-align: right; }
        .order-summary-table .total-row td { font-weight: bold; color: var(--gold-text-color); font-size: 1.2em; border-top: 1px solid var(--gold-text-color); }
        #app-notification-area { position: fixed; top: 20px; right: 20px; background-color: #333; color: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 3000; display: none; min-width: 250px; text-align: center; opacity: 0; transition: opacity 0.5s; }
        #app-notification-area.show { display: block; opacity: 1; }
        #app-notification-area.success { background-color: var(--success-color); } #app-notification-area.error { background-color: var(--danger-color); }
    </style>
</head>
<body>
    <div class="container">
        <h1>User Account and Management System</h1>
        <div class="message-output" id="app-status" style="margin-bottom: 20px;">Initializing... Please wait.</div>
        <div id="app-notification-area"></div>

        <div id="logged-out-view">
            <div class="section" id="registration">
                <h2>User Registration</h2>
                <form id="reg-form">
                    <label for="reg-username">Username</label><input type="text" id="reg-username" required>
                    <label for="reg-email">Email</label><input type="email" id="reg-email" required>
                    <div class="input-group">
                        <div><label for="reg-country-code">Country Code</label><input type="text" id="reg-country-code" value="+91" required></div>
                        <div><label for="reg-phone">Phone Number</label><input type="tel" id="reg-phone" required></div>
                    </div>
                    <label for="reg-password">Password</label><input type="password" id="reg-password" required>
                    <button type="submit">Register</button>
                    <div class="message-output" id="reg-message"></div>
                </form>
            </div>

            <div class="section" id="login">
                <h2>Login</h2>
                <form id="login-form">
                    <label for="login-username">Username</label><input type="text" id="login-username" value="testuser" required>
                    <label for="login-password">Password</label><input type="password" id="login-password" value="password123" required>
                    <button type="submit">Login</button>
                    <div class="message-output" id="login-message"></div>
                </form>
            </div>
             <div class="section" id="recovery-system">
                <h2>Account Recovery</h2>
                <p>Recovery systems are available for registered users.</p>
            </div>
        </div>

        <div id="logged-in-view" style="display: none;">
            <div class="section" id="status-nav">
                <h2>Session Status & Navigation</h2>
                <p><strong>Login Status:</strong> <span id="login-status-placeholder" style="color: var(--success-color);"></span></p>
                <div class="input-group">
                    <button type="button" id="logout-btn" class="btn-danger">Logout</button>
                </div>
            </div>

            <div class="section" id="change-credentials">
                <h2>Change Account Credentials</h2>
                <p>Functionality to change credentials would be available here.</p>
            </div>

            <div class="section" id="delete-account">
                <h2>Delete Account Permanently</h2>
                <form id="delete-account-form">
                    <label>Enter your password to confirm:</label><input type="password" id="del_password" required>
                    <div class="confirmation-group">
                        <h3>Confirm Deletion</h3>
                        <label><input type="checkbox" class="confirm-delete-box" required> All my data will be permanently deleted.</label>
                        <label><input type="checkbox" class="confirm-delete-box" required> This action is irreversible.</label>
                        <label><input type="checkbox" class="confirm-delete-box" required> I want to proceed with deleting my account.</label>
                    </div>
                    <button type="submit" class="btn-danger">Delete Account Permanently</button>
                    <div class="message-output" id="delete-account-message"></div>
                </form>
            </div>

            <div class="section" id="account-data">
                <h2>Account Data</h2>
                <div class="sub-section">
                    <h3>Account Shipping Address</h3>
                    <form id="ship-address-form">
                        <label for="ship-name">Recipient Name</label><input type="text" id="ship-name" name="recipientName">
                        <label for="ship-city">City</label><input type="text" id="ship-city" name="city">
                        <label for="ship-state">State</label><input type="text" id="ship-state" name="state">
                        <label for="ship-pincode">Pincode</label><input type="number" id="ship-pincode" name="pincode">
                        <button type="submit">Save or Update Shipping Details</button>
                    </form>
                    <h4>Saved Shipping Details</h4>
                    <div class="message-output" id="saved-shipping-output">No shipping details saved yet.</div>
                </div>

                <div class="sub-section">
                    <h3>Orders Created</h3>
                    <div class="orders-container" id="orders-container">
                       </div>
                    <div class="message-output" id="orders-container-message">No orders found.</div>
                </div>

                <div class="sub-section">
                    <h3>Saved Products for Later</h3>
                    <div class="saved-products-container" id="saved-products-container">
                        </div>
                     <div class="message-output" id="saved-products-container-message">No saved products.</div>
                </div>

                <div class="sub-section" id="notifications-section">
                    <h3>User Notifications</h3>
                    <div id="notifications-list"></div>
                    <div class="message-output" id="notifications-message">No new notifications.</div>
                    <button class="btn-danger" id="delete-all-notifications-btn">Delete All Notifications</button>
                </div>

                <div class="sub-section" id="activity-section">
                    <h3>Your Activity</h3>
                    <div id="activity-list"></div>
                    <div class="message-output" id="activity-message">No recent activity.</div>
                    <button class="btn-danger" id="delete-all-activity-btn">Delete All Activity History</button>
                </div>

                <div class="sub-section" id="support-chat-section">
                    <h3>Message Support Agent</h3>
                    <div id="start-chat-container">
                        <p>Have a question? Start a chat with one of our support agents.</p>
                        <button id="start-chat-btn">Start New Chat</button>
                    </div>
                    <div id="active-chat-container" style="display: none;">
                        <div class="chat-container">
                            <div class="chat-window" id="chat-window"></div>
                            <div class="chat-input-area">
                                <textarea id="chat-message-input" placeholder="Type your message..." rows="2"></textarea>
                                <button id="send-chat-message-btn">Send</button>
                            </div>
                        </div>
                        <button class="btn-danger" id="end-chat-btn" style="margin-top: 20px;">End Chat & Delete History</button>
                    </div>
                </div>

                <div class="sub-section" id="orders-saved-payment-pending">
                    <h3>Orders Saved (Payment Pending)</h3>
                    <div id="cart-output-section">
                        <div class="message-output">No pending orders.</div>
                    </div>
                </div>
            </div>

            <div class="section" id="user-cart-section">
                <h2>Your Cart</h2>
                <div class="cart-items-container" id="cart-items-container">
                     <div class="message-output">Your cart is empty.</div>
                </div>
                <div class="cart-total-section">
                    <h3>Grand Total: <span id="cart-grand-total">$0.00</span></h3>
                    <button class="btn-success" id="cart-proceed-btn" disabled>Proceed</button>
                </div>
            </div>
        </div>
        <div id="shipping-modal" class="checkout-modal">
            <div class="checkout-modal-content">
                <span class="close-modal">&times;</span>
                <h2>Step 1: Shipping Details</h2>
                <div class="sub-section">
                    <h4>Use Saved Shipping Address?</h4>
                    <div id="modal-saved-shipping-output" class="message-output"></div>
                    <button id="use-saved-address-btn">Yes, Use This Address</button>
                </div>
                <div class="sub-section" id="modal-shipping-form-container">
                    <h4>Or, Enter a New Address</h4>
                    <form id="modal-ship-address-form">
                        <label>Recipient Name</label><input type="text" id="modal-ship-name" required>
                        <label>City</label><input type="text" id="modal-ship-city" required>
                        <label>State</label><input type="text" id="modal-ship-state" required>
                        <label>Pincode</label><input type="number" id="modal-ship-pincode" required>
                    </form>
                </div>
                <button class="btn-success" id="proceed-to-summary-btn">Proceed to Order Summary</button>
            </div>
        </div>

        <div id="summary-modal" class="checkout-modal">
            <div class="checkout-modal-content">
                 <span class="close-modal">&times;</span>
                <h2>Step 2: Confirm Order & Payment</h2>
                <div id="order-summary-output"></div>
                <div class="message-output" id="payment-status-message">Awaiting payment.</div>
                <button class="btn-success" id="proceed-to-razorpay-btn">Proceed to Checkout</button>
            </div>
        </div>

        <div id="confirmation-modal" class="checkout-modal">
            <div class="checkout-modal-content">
                <span class="close-modal">&times;</span>
                <h2 style="color:var(--success-color); background: none; -webkit-background-clip: unset; background-clip: unset;">Order Placed Successfully!</h2>
                <p>Thank you for your purchase. Your order has been created and saved to your account.</p>
                <div id="final-order-confirmation-details"></div>
                <button id="close-confirmation-modal-btn">Close</button>
            </div>
        </div>

        <p id="app-version-display" style="text-align: center; font-size: 0.8em; color: #777; margin-top: 40px;">Version: 2.0.0</p>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE & MOCK DATA ---
    let currentUser = null;
    let users = {}; // Will store registered users: { username: { ... } }
    let cart = {}; // { productId: { name, price, quantity, image } }

    // Mock Database of Products
    const products = {
        'PROD001': { name: 'Wireless Bluetooth Headphones', price: 75.00, image: 'https://via.placeholder.com/300x200.png?text=Headphones' },
        'PROD002': { name: 'Smart Fitness Watch', price: 120.00, image: 'https://via.placeholder.com/300x200.png?text=Smart+Watch' },
        'PROD003': { name: 'Premium Wireless Earbuds', price: 95.00, image: 'https://via.placeholder.com/100x100.png?text=Earbuds' },
        'PROD004': { name: 'Leather-bound Journal', price: 25.00, image: 'https://via.placeholder.com/100x100.png?text=Journal' }
    };
    
    // --- UI ELEMENT SELECTORS ---
    const loggedOutView = document.getElementById('logged-out-view');
    const loggedInView = document.getElementById('logged-in-view');
    const appStatus = document.getElementById('app-status');
    const notificationArea = document.getElementById('app-notification-area');

    // Forms
    const regForm = document.getElementById('reg-form');
    const loginForm = document.getElementById('login-form');
    const deleteAccountForm = document.getElementById('delete-account-form');
    const shipAddressForm = document.getElementById('ship-address-form');

    // Buttons
    const logoutBtn = document.getElementById('logout-btn');
    const deleteAllNotificationsBtn = document.getElementById('delete-all-notifications-btn');
    const deleteAllActivityBtn = document.getElementById('delete-all-activity-btn');
    const startChatBtn = document.getElementById('start-chat-btn');
    const endChatBtn = document.getElementById('end-chat-btn');
    const sendChatMessageBtn = document.getElementById('send-chat-message-btn');
    const cartProceedBtn = document.getElementById('cart-proceed-btn');

    // --- HELPER FUNCTIONS ---
    const showNotification = (message, type = 'info', duration = 3000) => {
        notificationArea.textContent = message;
        notificationArea.className = ``;
        notificationArea.classList.add(type, 'show');
        setTimeout(() => notificationArea.classList.remove('show'), duration);
    };

    const toggleLoading = (button, isLoading) => {
        button.disabled = isLoading;
        if (isLoading) {
            button.classList.add('loading-spinner');
        } else {
            button.classList.remove('loading-spinner');
        }
    };
    
    const updateLoginStatus = (user) => {
        currentUser = user;
        if (user) {
            loggedOutView.style.display = 'none';
            loggedInView.style.display = 'block';
            document.getElementById('login-status-placeholder').textContent = `Logged in as ${user.username}`;
            // Populate user-specific data
            renderSavedProducts();
            renderCart();
            renderNotifications();
            renderActivity();
            renderShippingAddress();
        } else {
            loggedOutView.style.display = 'block';
            loggedInView.style.display = 'none';
        }
    };

    const addActivity = (text) => {
        if (!currentUser.activity) currentUser.activity = [];
        currentUser.activity.unshift({ text, date: new Date() });
        renderActivity();
    };

    // --- RENDER FUNCTIONS ---
    const renderSavedProducts = () => {
        const container = document.getElementById('saved-products-container');
        const message = document.getElementById('saved-products-container-message');
        container.innerHTML = '';
        const saved = currentUser?.savedProducts || [];
        if (saved.length === 0) {
            message.style.display = 'block';
            return;
        }
        message.style.display = 'none';
        saved.forEach(productId => {
            const product = products[productId];
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
                <img src="${product.image}" alt="${product.name}">
                <h4>${product.name}</h4><p>Price: $${product.price.toFixed(2)}</p>
                <div class="input-group">
                    <button class="btn-secondary move-to-cart-btn" data-id="${productId}">Move to Cart</button>
                    <button class="btn-danger remove-saved-btn" data-id="${productId}">Remove</button>
                </div>`;
            container.appendChild(card);
        });
    };
    
    const renderCart = () => {
        const container = document.getElementById('cart-items-container');
        const totalSpan = document.getElementById('cart-grand-total');
        container.innerHTML = '';
        let grandTotal = 0;
        const cartKeys = Object.keys(cart);

        if (cartKeys.length === 0) {
            container.innerHTML = '<div class="message-output">Your cart is empty.</div>';
            cartProceedBtn.disabled = true;
        } else {
            cartKeys.forEach(key => {
                const item = cart[key];
                const itemTotal = item.price * item.quantity;
                grandTotal += itemTotal;
                const cartItemEl = document.createElement('div');
                cartItemEl.className = 'cart-item';
                cartItemEl.innerHTML = `
                    <img src="${item.image}" alt="${item.name}">
                    <div class="cart-item-details">
                        <h4>${item.name}</h4>
                        <p>Quantity: ${item.quantity}</p>
                        <p>Price: $${item.price.toFixed(2)} each</p>
                    </div>
                    <h4>$${itemTotal.toFixed(2)}</h4>`;
                container.appendChild(cartItemEl);
            });
            cartProceedBtn.disabled = false;
        }
        totalSpan.textContent = `$${grandTotal.toFixed(2)}`;
    };

    const renderNotifications = () => {
        const list = document.getElementById('notifications-list');
        const message = document.getElementById('notifications-message');
        list.innerHTML = '';
        const notifs = currentUser?.notifications || [];
        if (notifs.length === 0) {
            message.style.display = 'block';
            list.style.display = 'none';
            return;
        }
        message.style.display = 'none';
        list.style.display = 'block';
        notifs.forEach(n => {
            list.innerHTML += `<div class="notification-item">${n.text} <span>${new Date(n.date).toLocaleDateString()}</span></div>`;
        });
    };

    const renderActivity = () => {
        const list = document.getElementById('activity-list');
        const message = document.getElementById('activity-message');
        list.innerHTML = '';
        const activities = currentUser?.activity || [];
        if (activities.length === 0) {
            message.style.display = 'block';
            list.style.display = 'none';
            return;
        }
        message.style.display = 'none';
        list.style.display = 'block';
        activities.forEach(a => {
            list.innerHTML += `<div class="activity-item">${a.text} <span>${new Date(a.date).toLocaleDateString()}</span></div>`;
        });
    };

    const renderShippingAddress = () => {
        const output = document.getElementById('saved-shipping-output');
        const address = currentUser?.shippingAddress;
        if (address && Object.keys(address).length > 0) {
            output.innerHTML = `<strong>${address.recipientName}</strong><br>
                                ${address.city}, ${address.state}<br>
                                Pincode: ${address.pincode}`;
        } else {
            output.textContent = 'No shipping details saved yet.';
        }
    };


    // --- EVENT LISTENERS ---

    // Registration
    regForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        toggleLoading(btn, true);
        const username = document.getElementById('reg-username').value;
        if (users[username]) {
            showNotification('Username already exists.', 'error');
            toggleLoading(btn, false);
            return;
        }
        users[username] = {
            username: username,
            email: document.getElementById('reg-email').value,
            password: document.getElementById('reg-password').value,
            phone: document.getElementById('reg-phone').value,
            countryCode: document.getElementById('reg-country-code').value,
            savedProducts: ['PROD001', 'PROD002'], // Default saved items
            notifications: [{text: 'Welcome to the platform!', date: new Date()}],
            activity: [{text: 'Account created', date: new Date()}],
            shippingAddress: {}
        };
        setTimeout(() => {
            showNotification('Registration successful! Please log in.', 'success');
            regForm.reset();
            toggleLoading(btn, false);
        }, 1000);
    });

    // Login
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        toggleLoading(btn, true);
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        setTimeout(() => {
            if (users[username] && users[username].password === password) {
                showNotification(`Welcome back, ${username}!`, 'success');
                cart = {'PROD003': {...products['PROD003'], quantity:1 }, 'PROD004': {...products['PROD004'], quantity: 2}}; // Default cart
                updateLoginStatus(users[username]);
            } else {
                showNotification('Invalid username or password.', 'error');
            }
            toggleLoading(btn, false);
        }, 1000);
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
        showNotification('You have been logged out.', 'info');
        updateLoginStatus(null);
        cart = {};
    });

    // Delete Account
    deleteAccountForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (document.getElementById('del_password').value !== currentUser.password) {
            showNotification('Incorrect password.', 'error');
            return;
        }
        delete users[currentUser.username];
        showNotification('Account deleted successfully.', 'success');
        updateLoginStatus(null);
    });

    // Save Shipping Address
    shipAddressForm.addEventListener('submit', (e) => {
        e.preventDefault();
        currentUser.shippingAddress = {
            recipientName: document.getElementById('ship-name').value,
            city: document.getElementById('ship-city').value,
            state: document.getElementById('ship-state').value,
            pincode: document.getElementById('ship-pincode').value
        };
        showNotification('Shipping address saved!', 'success');
        addActivity('Updated shipping address');
        renderShippingAddress();
    });

    // Saved Products container actions (delegated)
    document.getElementById('saved-products-container').addEventListener('click', (e) => {
        const id = e.target.dataset.id;
        if (!id) return;
        
        if (e.target.matches('.move-to-cart-btn')) {
            // Add to cart
            if (cart[id]) {
                cart[id].quantity++;
            } else {
                cart[id] = { ...products[id], quantity: 1 };
            }
            // Remove from saved
            currentUser.savedProducts = currentUser.savedProducts.filter(pId => pId !== id);
            showNotification(`${products[id].name} moved to cart.`, 'success');
            renderCart();
            renderSavedProducts();
        } else if (e.target.matches('.remove-saved-btn')) {
            currentUser.savedProducts = currentUser.savedProducts.filter(pId => pId !== id);
            showNotification(`${products[id].name} removed from saved list.`, 'info');
            renderSavedProducts();
        }
    });

    // Notification & Activity Deletion
    deleteAllNotificationsBtn.addEventListener('click', () => {
        currentUser.notifications = [];
        renderNotifications();
        showNotification('All notifications cleared.', 'info');
    });

    deleteAllActivityBtn.addEventListener('click', () => {
        currentUser.activity = [];
        renderActivity();
        showNotification('Activity history cleared.', 'info');
    });
    
    // Support Chat
    startChatBtn.addEventListener('click', () => {
        document.getElementById('start-chat-container').style.display = 'none';
        document.getElementById('active-chat-container').style.display = 'block';
        document.getElementById('chat-window').innerHTML = '<div class="chat-message admin"><p>Hello! How can I help you today?</p></div>';
    });
    
    endChatBtn.addEventListener('click', () => {
        document.getElementById('start-chat-container').style.display = 'block';
        document.getElementById('active-chat-container').style.display = 'none';
        showNotification('Chat ended and history deleted.', 'info');
    });

    sendChatMessageBtn.addEventListener('click', () => {
        const input = document.getElementById('chat-message-input');
        if (input.value.trim() === '') return;
        const chatWindow = document.getElementById('chat-window');
        const messageHTML = `<div class="chat-message user"><p>${input.value.trim()}</p></div>`;
        chatWindow.insertAdjacentHTML('beforeend', messageHTML);
        input.value = '';
        chatWindow.scrollTop = chatWindow.scrollHeight;
    });

    // --- CHECKOUT FLOW ---
    const shippingModal = document.getElementById('shipping-modal');
    const summaryModal = document.getElementById('summary-modal');
    const confirmationModal = document.getElementById('confirmation-modal');
    
    const closeAllModals = () => {
        shippingModal.style.display = 'none';
        summaryModal.style.display = 'none';
        confirmationModal.style.display = 'none';
    };
    
    // Add close listeners to all modal close buttons
    document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', closeAllModals));
    document.getElementById('close-confirmation-modal-btn').addEventListener('click', closeAllModals);

    cartProceedBtn.addEventListener('click', () => {
        const address = currentUser.shippingAddress;
        const output = document.getElementById('modal-saved-shipping-output');
        const useBtn = document.getElementById('use-saved-address-btn');
        if(address && address.recipientName){
            output.innerHTML = `<strong>${address.recipientName}</strong>, ${address.city}, ${address.state} - ${address.pincode}`;
            useBtn.style.display = 'block';
        } else {
            output.textContent = "No saved address found. Please add one.";
            useBtn.style.display = 'none';
        }
        shippingModal.style.display = 'block';
    });
    
    document.getElementById('use-saved-address-btn').addEventListener('click', () => {
        const address = currentUser.shippingAddress;
        document.getElementById('modal-ship-name').value = address.recipientName;
        document.getElementById('modal-ship-city').value = address.city;
        document.getElementById('modal-ship-state').value = address.state;
        document.getElementById('modal-ship-pincode').value = address.pincode;
        document.getElementById('modal-shipping-form-container').style.opacity = '0.5';
    });

    document.getElementById('proceed-to-summary-btn').addEventListener('click', () => {
        const shipName = document.getElementById('modal-ship-name').value;
        if(!shipName) {
            showNotification('Please provide a recipient name.', 'error');
            return;
        }
        
        const orderId = `ORD-${Date.now()}`;
        let cartTotal = Object.values(cart).reduce((acc, item) => acc + (item.price * item.quantity), 0);
        const shippingCost = 5.00;
        const gstRate = 0.18; // 18%
        const gstAmount = cartTotal * gstRate;
        const finalTotal = cartTotal + shippingCost + gstAmount;

        const shippingDetails = {
            name: shipName,
            city: document.getElementById('modal-ship-city').value,
            state: document.getElementById('modal-ship-state').value,
        };

        const summaryHTML = `
            <h4>Order Summary (ID: ${orderId})</h4>
            <p><strong>Shipping To:</strong> ${shippingDetails.name}, ${shippingDetails.city}, ${shippingDetails.state}</p>
            <table class="order-summary-table">
                <tr><td>Subtotal</td><td>$${cartTotal.toFixed(2)}</td></tr>
                <tr><td>Shipping Fee</td><td>$${shippingCost.toFixed(2)}</td></tr>
                <tr><td>GST (18%)</td><td>$${gstAmount.toFixed(2)}</td></tr>
                <tr class="total-row"><td>Grand Total</td><td>$${finalTotal.toFixed(2)}</td></tr>
            </table>
            <div id="razorpay-data-store" style="display:none;"
                 data-order-id="${orderId}" data-amount="${Math.round(finalTotal * 100)}"
                 data-name="${currentUser.username}" data-email="${currentUser.email}" data-phone="${currentUser.phone}">
            </div>`;

        document.getElementById('order-summary-output').innerHTML = summaryHTML;
        closeAllModals();
        summaryModal.style.display = 'block';

        const cartOutputContainer = document.getElementById('cart-output-section');
        if (cartOutputContainer.querySelector('.message-output')) cartOutputContainer.innerHTML = '';
        const pendingOrderEl = document.createElement('div');
        pendingOrderEl.className = 'order-item';
        pendingOrderEl.id = `pending-${orderId}`;
        pendingOrderEl.innerHTML = summaryHTML + `<p style="color:orange; font-size:0.9em; text-align:right;">Status: Awaiting Payment</p>`;
        cartOutputContainer.appendChild(pendingOrderEl);
    });
    
    document.getElementById('proceed-to-razorpay-btn').addEventListener('click', (e) => {
        const dataStore = document.getElementById('razorpay-data-store');
        const btn = e.target;
        toggleLoading(btn, true);

        const options = {
            "key": "rzp_test_YOUR_KEY_HERE", // Replace with your key
            "amount": dataStore.dataset.amount,
            "currency": "USD",
            "name": "Golden Emporium",
            "description": `Payment for Order ${dataStore.dataset.orderId}`,
            "image": "https://via.placeholder.com/128",
            "order_id": "", // Can be created via backend
            "handler": function (response){
                toggleLoading(btn, false);
                onPaymentSuccess(response, dataStore.dataset.orderId);
            },
            "prefill": {
                "name": dataStore.dataset.name,
                "email": dataStore.dataset.email,
                "contact": dataStore.dataset.phone
            },
            "theme": {
                "color": "#b38728"
            },
            "modal": {
                "ondismiss": function(){
                    toggleLoading(btn, false);
                    showNotification('Payment was not completed.', 'error');
                }
            }
        };
        const rzp = new Razorpay(options);
        rzp.open();
    });

    const onPaymentSuccess = (response, orderId) => {
        showNotification('Payment Successful! Creating order...', 'success');
        
        const pendingItem = document.getElementById(`pending-${orderId}`);
        const finalDetailsHTML = pendingItem.innerHTML.replace(/<p.*>.*<\/p>/, `<p style="color:var(--success-color); font-size:0.9em;">Payment ID: ${response.razorpay_payment_id}</p>`);
        
        // Add to main "Orders Created" list
        const ordersContainer = document.getElementById('orders-container');
        if (document.querySelector('#orders-container-message')) document.querySelector('#orders-container-message').style.display = 'none';
        const newOrderItem = document.createElement('div');
        newOrderItem.className = 'order-item';
        newOrderItem.innerHTML = finalDetailsHTML;
        ordersContainer.appendChild(newOrderItem);
        
        // Final confirmation modal
        document.getElementById('final-order-confirmation-details').innerHTML = finalDetailsHTML;
        closeAllModals();
        confirmationModal.style.display = 'block';

        // Cleanup
        pendingItem.remove();
        if (document.getElementById('cart-output-section').children.length === 0) {
             document.getElementById('cart-output-section').innerHTML = '<div class="message-output">No pending orders.</div>';
        }
        cart = {}; // Empty the cart
        renderCart();
        addActivity(`Placed a new order: ${orderId}`);
    };
    
    // --- INITIALIZATION ---
    appStatus.textContent = 'Application Initialized. Please Register or Login.';
    // By default, start with the logged-out view.
    updateLoginStatus(null);
});
</script>

</body>
</html>
