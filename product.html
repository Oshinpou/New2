<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Product Page - imacx Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and base styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* Lighter background */
            color: #1f2937;
        }
        
        /* Styles for the custom message box */
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #10b981; /* Green color */
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            transform: translateX(120%);
            opacity: 0;
        }

        .message-box.show {
            transform: translateX(0);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="messageBox" class="message-box"></div>

    <nav class="bg-white p-4 flex items-center justify-between border-b border-gray-200 shadow-sm sticky top-0 z-50">
        <div class="flex items-center space-x-3">
            <span class="text-2xl font-bold text-yellow-600">imacx</span>
            <img src="https://placehold.co/40x40/d6a32d/ffffff?text=im" alt="imacx logo" class="h-10 w-10 rounded-full">
        </div>
        <div class="flex items-center space-x-4">
            <a href="home.html" class="text-gray-600 hover:text-yellow-600 font-semibold transition-colors duration-200">Home</a>
            <a href="account.html" class="text-gray-600 hover:text-yellow-600 font-semibold transition-colors duration-200">Account</a>
            <a href="basket.html" class="text-gray-600 hover:text-yellow-600 font-semibold transition-colors duration-200">Basket</a>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl flex flex-wrap lg:flex-nowrap gap-8 mt-6">
        <div class="product-media w-full lg:w-1/2 p-4 bg-white rounded-xl shadow-md border border-gray-200">
            <div id="slider-content" class="w-full h-96 flex items-center justify-center overflow-hidden bg-gray-100 rounded-xl mb-4">
                <p class="text-gray-400">Loading images...</p>
            </div>
            <div class="flex justify-center space-x-4">
                <button onclick="moveSlider(-1)" class="bg-yellow-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-yellow-700 transition-colors duration-200">Previous</button>
                <button onclick="moveSlider(1)" class="bg-yellow-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-yellow-700 transition-colors duration-200">Next</button>
            </div>
        </div>

        <div class="product-info w-full lg:w-1/2 p-4">
            <h1 id="productName" class="text-4xl font-extrabold text-gray-900 mb-2">Loading Product...</h1>
            <p class="text-sm text-gray-500 mb-4">
                Category: <span id="productCategory" class="font-semibold text-gray-700"></span>, Subcategory: <span id="productSubcategory" class="font-semibold text-gray-700"></span>
            </p>

            <p class="text-3xl font-bold text-yellow-600 mb-2">
                ₹<span id="productPrice">0.00</span>
                <span id="discountedPrice" class="text-xl text-red-500 line-through font-normal ml-2"></span>
            </p>

            <div id="productVariants" class="flex flex-wrap items-center gap-4 my-4">
                </div>

            <div class="flex items-center space-x-4 my-4">
                <div class="quantity-control flex items-center border border-gray-300 rounded-md">
                    <button id="decreaseQty" class="px-3 py-1 text-xl font-bold text-white bg-yellow-600 rounded-l-md hover:bg-yellow-700 transition-colors duration-200">-</button>
                    <input type="number" id="quantityInput" value="1" min="1" class="w-16 text-center border-none focus:outline-none bg-white text-gray-800">
                    <button id="increaseQty" class="px-3 py-1 text-xl font-bold text-white bg-yellow-600 rounded-r-md hover:bg-yellow-700 transition-colors duration-200">+</button>
                </div>
                <button id="addToBasketBtn" class="add-to-basket-btn bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-yellow-700 transition-colors duration-200">Add to Basket</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl mt-8">
        <h2 class="text-2xl font-bold text-yellow-600 border-b-2 border-yellow-600 pb-2 mb-4">Product Details</h2>
        <div id="productDescription" class="text-gray-600 leading-relaxed">
            <p>Loading description...</p>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl mt-8">
        <h2 class="text-2xl font-bold text-yellow-600 border-b-2 border-yellow-600 pb-2 mb-4">Customer Reviews</h2>
        <div id="reviewsList" class="space-y-4">
            <p class="text-gray-400">No reviews yet.</p>
        </div>

        <h3 class="text-xl font-bold text-yellow-600 mt-8 mb-4">Write a Review</h3>
        <form id="reviewForm" class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
            <label for="reviewerName" class="block text-gray-700 font-semibold mb-2">Your Name:</label>
            <input type="text" id="reviewerName" required class="w-full max-w-md p-2 border border-gray-300 rounded-md mb-4 focus:ring-yellow-500 focus:border-yellow-500">

            <label class="block text-gray-700 font-semibold mb-2">Rating:</label>
            <div id="reviewRating" class="star-rating flex space-x-1 text-3xl mb-4">
                <span data-value="1" class="cursor-pointer text-gray-300 hover:text-yellow-500 transition-colors duration-200">&#9733;</span>
                <span data-value="2" class="cursor-pointer text-gray-300 hover:text-yellow-500 transition-colors duration-200">&#9733;</span>
                <span data-value="3" class="cursor-pointer text-gray-300 hover:text-yellow-500 transition-colors duration-200">&#9733;</span>
                <span data-value="4" class="cursor-pointer text-gray-300 hover:text-yellow-500 transition-colors duration-200">&#9733;</span>
                <span data-value="5" class="cursor-pointer text-gray-300 hover:text-yellow-500 transition-colors duration-200">&#9733;</span>
            </div>
            <input type="hidden" id="selectedRating" value="0">

            <label for="reviewComment" class="block text-gray-700 font-semibold mb-2">Your Review:</label>
            <textarea id="reviewComment" rows="5" required class="w-full max-w-md p-2 border border-gray-300 rounded-md mb-4 focus:ring-yellow-500 focus:border-yellow-500"></textarea>

            <button type="submit" class="bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-700 transition-colors duration-200">Submit Review</button>
        </form>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl mt-8">
        <h2 class="text-2xl font-bold text-yellow-600 border-b-2 border-yellow-600 pb-2 mb-4">Search Other Products</h2>
        <input type="text" id="productSearch" placeholder="Search by product name, category..." class="w-full max-w-lg p-3 border border-gray-300 rounded-md mb-6 focus:ring-yellow-500 focus:border-yellow-500">
        <div id="searchResults" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <p class="text-gray-400">Start typing to search products...</p>
        </div>
    </div>
    
    <footer class="bg-gray-800 text-white p-6 mt-12">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <h3 class="text-lg font-bold text-yellow-600">imacx Shop</h3>
                <p class="text-sm text-gray-400">© 2024 All rights reserved.</p>
            </div>
            <div class="flex space-x-6">
                <a href="#" class="text-gray-400 hover:text-yellow-600 transition-colors duration-200">About Us</a>
                <a href="#" class="text-gray-400 hover:text-yellow-600 transition-colors duration-200">Privacy Policy</a>
                <a href="#" class="text-gray-400 hover:text-yellow-600 transition-colors duration-200">Terms of Service</a>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>

    <script>
        // Initialize GunDB with a public server
        const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
        const productsDB = gun.get('imacx_shop_products'); // Using a custom root node to avoid conflicts

        // Mock Product Data, now with more details and variants
        const allProducts = [
            {
                id: 'imacx_product_1',
                name: 'Luxury Smartwatch',
                price: 2999.00,
                discountedPrice: 2499.00,
                images: [
                    'https://placehold.co/550x400/d6a32d/ffffff?text=Smartwatch_Front',
                    'https://placehold.co/550x400/d6a32d/ffffff?text=Smartwatch_Side',
                    'https://placehold.co/550x400/d6a32d/ffffff?text=Smartwatch_Back'
                ],
                category: 'Electronics',
                subcategory: 'Wearables',
                details: 'A stylish and powerful smartwatch with advanced health tracking and long-lasting battery life. Features a vibrant AMOLED display and a durable stainless steel frame.',
                variants: [
                    {
                        name: 'Color',
                        options: [
                            { value: 'Silver', price_modifier: 0 },
                            { value: 'Gold', price_modifier: 100 },
                            { value: 'Black', price_modifier: 0 }
                        ]
                    },
                    {
                        name: 'Band',
                        options: [
                            { value: 'Rubber', price_modifier: 0 },
                            { value: 'Leather', price_modifier: 500 },
                            { value: 'Metal Link', price_modifier: 800 }
                        ]
                    }
                ]
            },
            {
                id: 'imacx_product_2',
                name: 'Premium Leather Wallet',
                price: 850.00,
                images: [
                    'https://placehold.co/550x400/d6a32d/ffffff?text=Wallet_Closed',
                    'https://placehold.co/550x400/d6a32d/ffffff?text=Wallet_Open'
                ],
                category: 'Accessories',
                subcategory: 'Wallets',
                details: 'Handcrafted from premium full-grain leather, this wallet combines classic style with modern functionality. It includes RFID protection and multiple card slots.',
                variants: [
                    {
                        name: 'Leather Type',
                        options: [
                            { value: 'Cowhide', price_modifier: 0 },
                            { value: 'Sheepskin', price_modifier: 150 },
                        ]
                    }
                ]
            },
            {
                id: 'imacx_product_3',
                name: 'Ultra HD 4K Monitor',
                price: 25000.00,
                discountedPrice: null,
                images: [
                    'https://placehold.co/550x400/d6a32d/ffffff?text=Monitor'
                ],
                category: 'Electronics',
                subcategory: 'Displays',
                details: 'Experience stunning visuals with this 27-inch 4K monitor. Perfect for designers, gamers, and anyone who demands crisp, vibrant picture quality.',
                variants: []
            },
            {
                id: 'imacx_product_4',
                name: 'Wireless Bluetooth Earbuds',
                price: 1500.00,
                discountedPrice: 1200.00,
                images: [
                    'https://placehold.co/550x400/d6a32d/ffffff?text=Earbuds',
                    'https://placehold.co/550x400/d6a32d/ffffff?text=Earbuds_Case'
                ],
                category: 'Electronics',
                subcategory: 'Audio',
                details: 'Compact and powerful earbuds with active noise cancellation and a wireless charging case. Enjoy high-fidelity sound for up to 24 hours.',
                variants: [
                    {
                        name: 'Color',
                        options: [
                            { value: 'White', price_modifier: 0 },
                            { value: 'Black', price_modifier: 0 },
                            { value: 'Navy Blue', price_modifier: 50 },
                        ]
                    }
                ]
            }
        ];

        // Global state variables
        let currentProduct = null;
        let selectedVariantOptions = {};
        let currentQuantity = 1;
        let currentImageIndex = 0;
        let currentMedia = [];

        /**
         * Shows a custom message box with a given message.
         * Replaces the native alert() for a better user experience.
         * @param {string} message The message to display.
         * @param {string} type 'success' or 'error' to change styling.
         */
        function showMessage(message, type = 'success') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            // Update styling based on type
            if (type === 'success') {
                messageBox.style.backgroundColor = '#10b981'; // Green
            } else {
                messageBox.style.backgroundColor = '#ef4444'; // Red
            }
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        /**
         * Retrieves the current basket from localStorage.
         * @returns {Array} The basket array.
         */
        function getBasket() {
            try {
                return JSON.parse(localStorage.getItem('basket')) || [];
            } catch (e) {
                console.error("Error parsing basket from localStorage", e);
                return [];
            }
        }

        /**
         * Updates the basket in localStorage.
         * @param {Array} basket The new basket array to save.
         */
        function updateBasket(basket) {
            localStorage.setItem('basket', JSON.stringify(basket));
        }

        /**
         * Calculates and updates the displayed price based on selected variants.
         */
        function calculateCurrentPrice() {
            if (!currentProduct) return;

            let basePrice = parseFloat(currentProduct.price) || 0;
            let discountedPrice = currentProduct.discountedPrice !== null ? parseFloat(currentProduct.discountedPrice) : null;
            let finalPrice = basePrice;

            if (currentProduct.variants && Array.isArray(currentProduct.variants)) {
                currentProduct.variants.forEach(variant => {
                    const selectedOptionValue = selectedVariantOptions[variant.name];
                    if (selectedOptionValue) {
                        const selectedOption = variant.options.find(opt => opt.value === selectedOptionValue);
                        if (selectedOption) {
                            finalPrice += parseFloat(selectedOption.price_modifier) || 0;
                            if (discountedPrice !== null) {
                                discountedPrice += parseFloat(selectedOption.price_modifier) || 0;
                            }
                        }
                    }
                });
            }

            document.getElementById('productPrice').textContent = finalPrice.toFixed(2);
            const discountedPriceElement = document.getElementById('discountedPrice');
            if (discountedPrice !== null && discountedPrice < finalPrice) {
                    // Correctly display the original price and the discounted price
                document.getElementById('productPrice').textContent = discountedPrice.toFixed(2);
                discountedPriceElement.textContent = `(MRP ₹${finalPrice.toFixed(2)})`;
            } else {
                    document.getElementById('productPrice').textContent = finalPrice.toFixed(2);
                    discountedPriceElement.textContent = '';
            }
        }

        /**
         * Renders the product details on the page.
         * @param {object} product The product object from GunDB.
         */
        function renderProduct(product) {
            currentProduct = product;
            document.getElementById('pageTitle').textContent = product.name + ' - imacx Shop';
            document.getElementById('productName').textContent = product.name;
            document.getElementById('productCategory').textContent = product.category || 'N/A';
            document.getElementById('productSubcategory').textContent = product.subcategory || 'N/A';
            document.getElementById('productDescription').innerHTML = product.details || '<p class="text-gray-600">No detailed description available.</p>';

            // Render Image/Video Slider
            currentMedia = Array.isArray(product.images) ? product.images : [];
            if (currentMedia.length > 0) {
                updateSliderMedia();
            } else {
                document.getElementById('slider-content').innerHTML = '<p class="text-gray-400">No media to display.</p>';
            }

            // Render Variants
            const productVariantsDiv = document.getElementById('productVariants');
            productVariantsDiv.innerHTML = '';
            selectedVariantOptions = {};

            if (product.variants && Array.isArray(product.variants) && product.variants.length > 0) {
                product.variants.forEach(variant => {
                    const variantDiv = document.createElement('div');
                    variantDiv.className = 'flex flex-col space-y-2';
                    variantDiv.innerHTML = `<label for="variant-${variant.name.replace(/\s/g, '_')}" class="text-gray-700 font-medium">${variant.name}: </label>`;
                    const select = document.createElement('select');
                    select.id = `variant-${variant.name.replace(/\s/g, '_')}`;
                    select.className = 'p-2 border border-gray-300 rounded-md focus:ring-yellow-500 focus:border-yellow-500';
                    select.setAttribute('aria-label', `${variant.name} selection`);
                    select.onchange = (event) => {
                        selectedVariantOptions[variant.name] = event.target.value;
                        calculateCurrentPrice();
                    };

                    if (Array.isArray(variant.options)) {
                        variant.options.forEach(option => {
                            const opt = document.createElement('option');
                            opt.value = option.value;
                            opt.textContent = option.value;
                            select.appendChild(opt);
                        });
                    }
                    variantDiv.appendChild(select);
                    productVariantsDiv.appendChild(variantDiv);

                    // Set initial selected option
                    if (variant.options && variant.options.length > 0) {
                        selectedVariantOptions[variant.name] = variant.options[0].value;
                    }
                });
            } else {
                productVariantsDiv.innerHTML = '<p class="text-gray-400">No configurable variants.</p>';
            }

            calculateCurrentPrice();
            document.getElementById('addToBasketBtn').disabled = false;
        }

        /**
         * Updates the image/video slider with the current media item.
         */
        function updateSliderMedia() {
            const sliderContent = document.getElementById('slider-content');
            sliderContent.innerHTML = '';

            if (currentMedia.length > 0) {
                const mediaUrl = currentMedia[currentImageIndex];
                if (mediaUrl.match(/\.(jpeg|jpg|gif|png|webp)$/i)) {
                    const img = document.createElement('img');
                    img.src = mediaUrl;
                    img.alt = `Product image ${currentImageIndex + 1}`;
                    img.className = 'max-w-full max-h-full object-contain block rounded-xl';
                    // Fallback for broken images
                    img.onerror = () => img.src = `https://placehold.co/550x400/d6a32d/ffffff?text=Image+Not+Found`;
                    sliderContent.appendChild(img);
                } else {
                    sliderContent.innerHTML = `<p class="text-gray-400">Unsupported media type: ${mediaUrl}</p>`;
                }
            } else {
                sliderContent.innerHTML = '<p class="text-gray-400">No media available.</p>';
            }
        }

        /**
         * Moves the media slider left or right.
         * @param {number} direction -1 for left, 1 for right.
         */
        function moveSlider(direction) {
            if (currentMedia.length === 0) return;
            currentImageIndex += direction;
            if (currentImageIndex >= currentMedia.length) {
                currentImageIndex = 0;
            } else if (currentImageIndex < 0) {
                currentImageIndex = currentMedia.length - 1;
            }
            updateSliderMedia();
        }

        // --- Quantity Control ---
        document.getElementById('decreaseQty').addEventListener('click', () => {
            currentQuantity = Math.max(1, currentQuantity - 1);
            document.getElementById('quantityInput').value = currentQuantity;
        });

        document.getElementById('increaseQty').addEventListener('click', () => {
            currentQuantity++;
            document.getElementById('quantityInput').value = currentQuantity;
        });

        document.getElementById('quantityInput').addEventListener('change', (event) => {
            let value = parseInt(event.target.value);
            if (isNaN(value) || value < 1) {
                value = 1;
            }
            currentQuantity = value;
            event.target.value = currentQuantity;
        });

        // --- Add to Basket ---
        document.getElementById('addToBasketBtn').addEventListener('click', () => {
            if (!currentProduct) {
                showMessage('Product data not loaded yet. Please wait.', 'error');
                return;
            }

            const basket = getBasket();
            const effectivePrice = parseFloat(document.getElementById('productPrice').textContent) || 0;

            const itemToAdd = {
                id: currentProduct.id,
                name: currentProduct.name,
                image: currentMedia.length > 0 ? currentMedia[0] : 'https://placehold.co/120x120/d6a32d/ffffff?text=Product',
                category: currentProduct.category,
                subcategory: currentProduct.subcategory,
                variants: { ...selectedVariantOptions },
                price: effectivePrice,
                quantity: currentQuantity
            };

            const existingItemIndex = basket.findIndex(item =>
                item.id === itemToAdd.id &&
                JSON.stringify(item.variants) === JSON.stringify(itemToAdd.variants)
            );

            if (existingItemIndex > -1) {
                basket[existingItemIndex].quantity += itemToAdd.quantity;
            } else {
                basket.push(itemToAdd);
            }

            updateBasket(basket);
            showMessage(`${itemToAdd.quantity} x ${itemToAdd.name} added to basket!`);
        });

        // --- Review System ---
        let currentRating = 0;
        document.querySelectorAll('.star-rating span').forEach(star => {
            star.addEventListener('click', function() {
                currentRating = parseInt(this.dataset.value);
                document.getElementById('selectedRating').value = currentRating;
                document.querySelectorAll('.star-rating span').forEach((s, i) => {
                    s.classList.toggle('text-yellow-500', i < currentRating);
                    s.classList.toggle('text-gray-300', i >= currentRating);
                });
            });
        });

        document.getElementById('reviewForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!currentProduct) {
                showMessage('Cannot submit review: Product data not loaded.', 'error');
                return;
            }

            const reviewerName = document.getElementById('reviewerName').value.trim();
            const reviewComment = document.getElementById('reviewComment').value.trim();
            const rating = parseInt(document.getElementById('selectedRating').value);

            if (rating === 0 || !reviewerName || !reviewComment) {
                showMessage('Please select a star rating and fill in all fields.', 'error');
                return;
            }

            const review = {
                reviewer: reviewerName,
                rating: rating,
                comment: reviewComment,
                timestamp: Date.now()
            };

            // Store review in GunDB under the product's review node
            productsDB.get(currentProduct.id).get('reviews').set(review);

            showMessage('Review submitted successfully!');
            this.reset();
            document.querySelectorAll('.star-rating span').forEach(s => {
                s.classList.remove('text-yellow-500');
                s.classList.add('text-gray-300');
            });
            currentRating = 0;
        });

        /**
         * Renders reviews for a given product ID.
         * @param {string} productId The ID of the product.
         */
        function renderReviews(productId) {
            const reviewsListDiv = document.getElementById('reviewsList');
            reviewsListDiv.innerHTML = '<p class="text-gray-400">Loading reviews...</p>';
            let hasReviews = false;
            let initialLoadHandled = false; // Flag to ensure initial message is cleared once

            // Clear previous listeners to prevent duplicates if loadProduct is called multiple times
            productsDB.get(productId).get('reviews').off(); 

            productsDB.get(productId).get('reviews').map().on((review, key) => {
                // Ensure review data is valid and not a deletion signal from GunDB (null/undefined)
                if (review && review.reviewer && review.comment && review.rating) {
                    hasReviews = true;
                    // Only clear the "Loading reviews..." message on the first valid review received
                    if (!initialLoadHandled) {
                        reviewsListDiv.innerHTML = ''; // Clear initial message
                        initialLoadHandled = true;
                    }
                    
                    // Check if the review already exists to avoid re-adding
                    if (!document.getElementById(`review-${key}`)) {
                        const reviewDiv = document.createElement('div');
                        reviewDiv.className = 'review-item bg-gray-100 p-4 rounded-xl shadow-sm border border-gray-200';
                        reviewDiv.id = `review-${key}`; // Unique ID for each review
                        let starsHtml = '';
                        for (let i = 0; i < 5; i++) {
                            starsHtml += `<span class="text-2xl ${i < review.rating ? 'text-yellow-500' : 'text-gray-300'}">&#9733;</span>`;
                        }
                        reviewDiv.innerHTML = `
                            <strong class="text-gray-900">${review.reviewer}</strong>
                            <span class="text-sm text-gray-500 ml-2">${new Date(review.timestamp).toLocaleDateString()}</span>
                            <div class="flex my-1">${starsHtml}</div>
                            <p class="text-gray-700 mt-2">${review.comment}</p>
                        `;
                        reviewsListDiv.prepend(reviewDiv); // Add new reviews at the top
                    }
                } else if (!initialLoadHandled && key === undefined) { 
                    // This handles the case where the review node is initially empty or cleared
                    // and prevents "No reviews yet." from flashing before map() data arrives.
                    // 'key === undefined' often indicates the initial 'on' call for an empty node.
                    reviewsListDiv.innerHTML = '<p class="text-gray-400">No reviews yet.</p>';
                    initialLoadHandled = true; // Mark as handled to avoid further clearing
                }
            });
            
            // Fallback for when no reviews are found after a short delay (for async GunDB data)
            // This is a common pattern with GunDB's async nature if no data is immediately present.
            setTimeout(() => {
                if (!hasReviews && !initialLoadHandled) { // Check both flags
                    reviewsListDiv.innerHTML = '<p class="text-gray-400">No reviews yet.</p>';
                }
            }, 1500); // Give GunDB a moment to potentially fetch data
        }

        // --- Product Search from mock data ---
        const productSearchInput = document.getElementById('productSearch');
        const searchResultsDiv = document.getElementById('searchResults');

        function renderProductCard(product) {
            return `
                <a href="#${product.id}" class="product-card bg-white p-4 text-center rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-shadow duration-200 block">
                    <img src="${product.images[0]}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/120x120/d6a32d/ffffff?text=Product';" class="w-32 h-32 object-cover mx-auto mb-4 rounded-md">
                    <h3 class="text-lg font-semibold text-gray-900">${product.name}</h3>
                    <p class="text-xl font-bold text-yellow-600 mb-4">₹${(product.discountedPrice !== null ? product.discountedPrice : product.price).toFixed(2)}</p>
                    <span class="inline-block bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-700 transition-colors duration-200">View Product</span>
                </a>
            `;
        }

        productSearchInput.addEventListener('input', () => {
            const searchTerm = productSearchInput.value.toLowerCase().trim();
            searchResultsDiv.innerHTML = '';

            if (searchTerm.length < 2) {
                searchResultsDiv.innerHTML = '<p class="text-gray-400">Start typing to search products...</p>';
                return;
            }

            const filteredProducts = allProducts.filter(product =>
                product.name.toLowerCase().includes(searchTerm) ||
                (product.category && product.category.toLowerCase().includes(searchTerm)) ||
                (product.subcategory && product.subcategory.toLowerCase().includes(searchTerm))
            );

            if (filteredProducts.length > 0) {
                filteredProducts.forEach(product => {
                    searchResultsDiv.innerHTML += renderProductCard(product);
                });
            } else {
                searchResultsDiv.innerHTML = '<p class="text-gray-400">No products found matching your search.</p>';
            }
        });

        // Add a hash change listener to update the product view when the URL changes
        window.addEventListener('hashchange', () => {
            const productId = window.location.hash.substring(1);
            loadProduct(productId);
        });

        /**
         * Loads and renders a product from GunDB based on its ID.
         * If the product is not in GunDB, it falls back to the mock data.
         * @param {string} productId The ID of the product to load.
         */
        function loadProduct(productId) {
            if (!productId) {
                // If no product ID is specified, load the first product by default or show a message
                productId = allProducts[0]?.id; // Load the first product from mock data
                if (!productId) {
                    document.getElementById('productName').textContent = 'No Product Selected';
                    document.getElementById('productDescription').innerHTML = '<p class="text-gray-600">Please select a product to view its details.</p>';
                    document.getElementById('productPrice').textContent = '0.00';
                    document.getElementById('discountedPrice').textContent = '';
                    document.getElementById('productCategory').textContent = 'N/A';
                    document.getElementById('productSubcategory').textContent = 'N/A';
                    document.getElementById('slider-content').innerHTML = '<p class="text-gray-400">No media to display.</p>';
                    document.getElementById('productVariants').innerHTML = '<p class="text-gray-400">No configurable variants.</p>';
                    document.getElementById('addToBasketBtn').disabled = true;
                    document.getElementById('reviewsList').innerHTML = '<p class="text-gray-400">No reviews yet.</p>';
                    return;
                }
            }

            // Attempt to load from GunDB first
            productsDB.get(productId).once(data => {
                if (data && data.name) {
                    renderProduct(data);
                    renderReviews(productId);
                } else {
                    // Fallback to mock data if not found in GunDB
                    const productFromMock = allProducts.find(p => p.id === productId);
                    if (productFromMock) {
                        // Persist mock data to GunDB so it's available next time
                        productsDB.put({ [productId]: productFromMock }); // Use computed property name
                        renderProduct(productFromMock);
                        renderReviews(productId); // Render reviews for the now-persisted product
                    } else {
                        console.error('Product not found in GunDB or mock data:', productId);
                        showMessage('Product not found!', 'error');
                        // Reset product display
                        document.getElementById('productName').textContent = 'Product Not Found';
                        document.getElementById('productDescription').innerHTML = '<p class="text-gray-600">The product you are looking for does not exist.</p>';
                        document.getElementById('productPrice').textContent = '0.00';
                        document.getElementById('discountedPrice').textContent = '';
                        document.getElementById('productCategory').textContent = 'N/A';
                        document.getElementById('productSubcategory').textContent = 'N/A';
                        document.getElementById('slider-content').innerHTML = '<p class="text-gray-400">No media to display.</p>';
                        document.getElementById('productVariants').innerHTML = '<p class="text-gray-400">No configurable variants.</p>';
                        document.getElementById('addToBasketBtn').disabled = true;
                        document.getElementById('reviewsList').innerHTML = '<p class="text-gray-400">No reviews yet.</p>';
                    }
                }
            });
        }

        // Initial load of product based on URL hash or default
        document.addEventListener('DOMContentLoaded', () => {
            const initialProductId = window.location.hash.substring(1);
            loadProduct(initialProductId);
        });
    </script>
</body>
</html>
