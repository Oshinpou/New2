<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - IMACX</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dexie@3.0.3/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/tonic-ssr"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f9f9f9; }
    .order { background: #fff; border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 8px; }
    .field { margin-bottom: 5px; }
    .status-input { width: 100px; }
    button { padding: 6px 10px; margin-top: 10px; cursor: pointer; }
  </style>
</head>
<body>

  <h2>ðŸ§¾ IMACX Admin Orders</h2>
  <input type="text" id="search" placeholder="Search email or name">
  <button onclick="syncAndRender()">ðŸ”„ Manage Database</button>
  <div id="orders"></div>

  <script type="module">
    import { create } from 'https://cdn.jsdelivr.net/npm/@peerbit/core@0.15.19/+esm';

    const peer = await create();
    const ordersDB = await peer.open('orders');

    const gun = Gun('https://gun-manhattan.herokuapp.com/gun');
    const gorders = gun.get('imacx_orders');

    const db = new Dexie('localCache');
    db.version(1).stores({ orders: 'orderId' });

    let fuse;

    async function renderOrders(allOrders) {
      const container = document.getElementById('orders');
      container.innerHTML = '';
      allOrders.forEach(order => {
        const div = document.createElement('div');
        div.className = 'order';
        div.innerHTML = `
          <div class="field"><strong>ID:</strong> ${order.orderId}</div>
          <div class="field"><strong>Name:</strong> ${order.shipping?.recipient || 'N/A'}</div>
          <div class="field"><strong>Email:</strong> ${order.shipping?.email || 'N/A'}</div>
          <div class="field">
            <strong>Status:</strong> 
            <input type="text" value="${order.status || ''}" class="status-input" data-id="${order.orderId}">
          </div>
        `;
        container.appendChild(div);
      });

      // Handle inline status changes
      document.querySelectorAll('.status-input').forEach(input => {
        input.addEventListener('change', async e => {
          const orderId = e.target.dataset.id;
          const newStatus = e.target.value;
          const order = await db.orders.get(orderId);
          if (order) {
            order.status = newStatus;
            await db.orders.put(order);
            await ordersDB.put(order, order.orderId);
            gorders.get(order.orderId).put(order);
          }
        });
      });
    }

    async function syncAndRender() {
      const all = await ordersDB.query.all();
      await db.orders.bulkPut(all);
      const allOrders = await db.orders.toArray();
      renderOrders(allOrders);
      fuse = new Fuse(allOrders, {
        keys: ['shipping.email', 'shipping.recipient'],
        threshold: 0.3
      });
    }

    ordersDB.events.on('replicated', syncAndRender);
    await syncAndRender();

    // Search handler
    document.getElementById('search').addEventListener('input', e => {
      const results = fuse.search(e.target.value).map(x => x.item);
      renderOrders(results);
    });
  </script>

</body>
</html>
