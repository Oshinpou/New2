<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - IMACX Orders</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fafafa;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .order {
      background: white;
      border: 1px solid #ddd;
      margin: 15px 0;
      padding: 20px;
      border-radius: 8px;
    }
    .order span {
      font-weight: bold;
    }
    .status-container {
      margin-top: 10px;
    }
    .status-container input {
      padding: 5px;
      width: 200px;
    }
    .status-container button {
      padding: 5px 10px;
      margin-left: 5px;
    }
    #searchBar {
      padding: 10px;
      width: 300px;
      margin: 20px auto;
      display: block;
    }
  </style>
</head>
<body>
  <h1>Admin Orders Panel</h1>
  <input type="text" id="searchBar" placeholder="Search by Order ID..." />
  <div id="ordersContainer">Loading orders...</div>

  <script>
    const gun = Gun();
    const ordersContainer = document.getElementById('ordersContainer');
    const searchBar = document.getElementById('searchBar');

    // Load all orders
    function loadOrders(filter = "") {
      ordersContainer.innerHTML = "";
      gun.get('imacx_orders').map().once((orderData, orderId) => {
        if (!orderData || !orderData.data) return;

        const data = orderData.data;
        if (filter && !orderId.includes(filter)) return;

        const orderDiv = document.createElement('div');
        orderDiv.className = 'order';

        const id = orderId;
        const total = data.total || 'N/A';
        const name = data.name || 'N/A';
        const phone = (data.phone || '') + (data.altPhone || '');
        const address = `${data.address || ''}, ${data.city || ''}, ${data.state || ''}, ${data.country || ''} - ${data.pincode || ''}`;

        const statusInput = document.createElement('input');
        statusInput.placeholder = 'Enter status...';

        const updateBtn = document.createElement('button');
        updateBtn.textContent = 'Update Status';

        const statusDisplay = document.createElement('div');
        statusDisplay.style.marginTop = '5px';
        statusDisplay.style.color = 'green';

        // Load stored status from separate node
        gun.get('imacx_order_status').get(id).once(storedStatus => {
          if (storedStatus) {
            statusInput.value = storedStatus;
            statusDisplay.textContent = `Saved status: ${storedStatus}`;
          }
        });

        updateBtn.onclick = () => {
          const newStatus = statusInput.value.trim();
          if (newStatus) {
            gun.get('imacx_order_status').get(id).put(newStatus, ack => {
              if (ack.err) {
                alert("Failed to save status.");
              } else {
                alert("✅ Status saved!");
                statusDisplay.textContent = `Saved status: ${newStatus}`;
              }
            });
          }
        };

        const statusContainer = document.createElement('div');
        statusContainer.className = 'status-container';
        statusContainer.appendChild(statusInput);
        statusContainer.appendChild(updateBtn);
        statusContainer.appendChild(statusDisplay);

        orderDiv.innerHTML = `
          <span>Order ID:</span> ${id}<br>
          <span>Total:</span> ₹${total}<br>
          <span>Recipient:</span> ${name}<br>
          <span>Phone:</span> ${phone}<br>
          <span>Address:</span> ${address}<br>
        `;

        orderDiv.appendChild(statusContainer);
        ordersContainer.appendChild(orderDiv);
      });
    }

    searchBar.addEventListener('input', () => {
      const query = searchBar.value.trim();
      loadOrders(query);
    });

    loadOrders(); // Initial load
  </script>
</body>
</html>
