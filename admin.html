<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - imacx Orders (Global)</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <style>
    body {
      font-family: monospace;
      background: #fefefe;
      color: #222;
      padding: 20px;
    }
    h1 {
      text-align: center;
      font-family: sans-serif;
    }
    #searchInput {
      display: block;
      margin: 0 auto 20px;
      padding: 10px;
      width: 300px;
      border: 1px solid #aaa;
      border-radius: 5px;
    }
    .order-block {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      background: #fffbe6;
    }
    .order-block.highlight {
      border-color: goldenrod;
      background: #ffffd7;
    }
    pre {
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 14px;
    }
    select, button {
      margin-top: 10px;
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #bbb;
      font-family: sans-serif;
    }
    .btn {
      cursor: pointer;
      margin-left: 5px;
    }
    .update-btn {
      background: #3498db;
      color: white;
    }
    .delete-btn {
      background: #e74c3c;
      color: white;
    }
  </style>
</head>
<body>

  <h1>üåç imacx Admin - Orders Worldwide</h1>
  <input type="text" id="searchInput" placeholder="üîç Search Order ID or Email" oninput="filterOrders()" />

  <div id="ordersContainer"></div>

  <script>
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    const globalOrders = gun.get('imacx_orders');
    const ordersContainer = document.getElementById('ordersContainer');
    const allBlocks = [];

    const STATUS_LIST = [
      'Order Created',
      'Payment Done',
      'Order Cancelled',
      'Order Processing',
      'Out for Shipping',
      'Shipped',
      'Out for Delivery',
      'Delivered'
    ];

    function createOrderBlock(order) {
      if (!order || !order.orderId || !order.shipping || !order.basket) return;

      const block = document.createElement('div');
      block.className = 'order-block';
      block.setAttribute('data-order-id', order.orderId.toLowerCase());
      block.setAttribute('data-email', order.shipping.email.toLowerCase());

      const orderPre = document.createElement('pre');
      orderPre.textContent = JSON.stringify(order, null, 2);

      const statusLabel = document.createElement('label');
      statusLabel.textContent = "Update Status: ";
      const statusSelect = document.createElement('select');

      STATUS_LIST.forEach(status => {
        const option = document.createElement('option');
        option.value = status;
        option.textContent = status;
        if (status === order.status) option.selected = true;
        statusSelect.appendChild(option);
      });

      const updateBtn = document.createElement('button');
      updateBtn.className = 'btn update-btn';
      updateBtn.textContent = 'Update';
      updateBtn.onclick = () => {
        globalOrders.get(order.orderId).get('status').put(statusSelect.value);
        alert("‚úÖ Order status updated");
      };

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn delete-btn';
      deleteBtn.textContent = 'Delete';
      deleteBtn.onclick = () => {
        if (confirm("‚ùå Delete this order permanently?")) {
          globalOrders.get(order.orderId).put(null);
          block.remove();
        }
      };

      block.appendChild(orderPre);
      block.appendChild(statusLabel);
      block.appendChild(statusSelect);
      block.appendChild(updateBtn);
      block.appendChild(deleteBtn);

      ordersContainer.appendChild(block);
      allBlocks.push(block);
    }

    function loadOrders() {
      globalOrders.map().on(order => {
        const exists = allBlocks.find(b => b.getAttribute('data-order-id') === (order.orderId || '').toLowerCase());
        if (!exists) createOrderBlock(order);
      });
    }

    function filterOrders() {
      const query = document.getElementById('searchInput').value.trim().toLowerCase();
      allBlocks.forEach(block => {
        const id = block.getAttribute('data-order-id');
        const email = block.getAttribute('data-email');
        const match = id.includes(query) || email.includes(query);
        block.style.display = match ? '' : 'none';
        block.classList.toggle('highlight', match && query);
      });
    }

    window.onload = loadOrders;
  </script>

</body>
</html>
