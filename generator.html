<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Digital Page Generator</title>

  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --light-gray: #f8f9fa;
      --dark-gray: #343a40;
      --border-color: #dee2e6;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      background-color: var(--light-gray);
      color: var(--dark-gray);
    }
    .container {
      max-width: 960px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    nav {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      background-color: var(--dark-gray);
      color: white;
      border-radius: 8px 8px 0 0;
    }
    nav img {
      height: 40px;
      margin-right: 15px;
    }
    nav span {
      font-size: 1.5em;
      font-weight: bold;
    }
    nav a {
      color: white;
      text-decoration: none;
      margin-left: 20px;
      font-size: 1.1em;
    }
    h1, h2 {
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 10px;
      margin-top: 20px;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 1em;
    }
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      opacity: 0.9;
    }
    .delete-btn {
      background-color: #dc3545;
      margin-left: 15px;
      width: auto;
      padding: 5px 10px;
      font-size: 0.9em;
    }
    .variant-block, .link-item {
      padding: 15px;
      border: 1px dashed var(--secondary-color);
      border-radius: 5px;
      margin-bottom: 15px;
    }
    #links-list a {
      font-weight: bold;
      color: var(--primary-color);
    }
    #image-slider {
      width: 100%;
      height: 300px;
      background-color: #eee;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 5px;
    }
    #image-slider img {
      max-width: 100%;
      max-height: 100%;
    }
    #add-to-basket {
      background-color: #28a745;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
</head>
<body>
  <div id="app-root"></div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    const appRoot = document.getElementById('app-root');
    const urlParams = new URLSearchParams(window.location.search);
    const pageId = urlParams.get('id');

    const productsData = {
      categories: {
        "Food": ["Breakfast", "Chocolate", "Snacks", "Spread", "Cheese"],
        "Jewellery": ["Rings", "Necklaces", "Earrings"],
        "Digital": ["Software", "Courses", "E-books"],
        "Cosmetics": ["Skincare", "Makeup"]
      }
    };

    if (pageId) {
      renderProductPage(pageId);
    } else {
      renderGeneratorPage();
    }

    function renderGeneratorPage() {
      appRoot.innerHTML = `
        <div class="container">
          <h1>üìù Digital Page Generator</h1>
          <h2>Product Details</h2>
          <input id="product-name" type="text" placeholder="Product Name">
          <textarea id="product-details" placeholder="Full Product Description..."></textarea>
          <textarea id="slider-images" placeholder="Enter image URLs, separated by commas"></textarea>

          <h2>Category</h2>
          <select id="category-select"></select>
          <select id="subcategory-select"></select>

          <h2>Variants</h2>
          <div id="variants-container"></div>
          <button id="add-variant-btn" type="button">Add Variant Type</button>

          <h2>Pricing</h2>
          <div id="pricing-container"></div>

          <button id="generate-page-btn" type="button">üöÄ Generate Link & Save Page</button>

          <hr>
          <h1>üîó Generated Links</h1>
          <div id="links-list"></div>
          <button id="export-btn">üì§ Export All Pages</button>
          <input type="file" id="import-input" style="display:none;" />
          <button id="import-btn">üì• Import Pages</button>
        </div>
      `;
      setupGeneratorEventListeners();
      populateCategories();
      displayLinks();
    }

    function renderProductPage(id) {
      appRoot.innerHTML = `
        <div class="container">
          <nav>
            <img src="https://assets.stickpng.com/images/580b57fcd9996e24bc43c521.png" alt="imacx Logo"> <span>imacx</span>
            <a href="app.html">Home (Generator)</a>
            <a href="#">Account</a>
            <a href="#">Basket</a>
          </nav>
          <div id="product-content">
            <div id="image-slider"><p>Loading slider...</p></div>
            <h1 id="product-name">Loading...</h1>
            <p>Category: <span id="product-category"></span> | Subcategory: <span id="product-subcategory"></span></p>
            <div id="variant-selectors"></div>
            <h2>Price: ‚Çπ<span id="product-price">--</span></h2>
            <div>
              Quantity: <input id="quantity" type="number" value="1" min="1" style="width: 80px;">
            </div>
            <button id="add-to-basket" type="button">üõí Add to Basket</button>
            <h2>Details</h2>
            <div id="product-details"></div>
            <h2>‚≠ê Ratings & Reviews</h2>
            <div id="reviews-section"></div>
          </div>
        </div>
      `;
      loadProductData(id);
    }

    function setupGeneratorEventListeners() {
      document.getElementById('category-select').addEventListener('change', populateSubcategories);
      document.getElementById('add-variant-btn').addEventListener('click', addVariantBlock);
      document.getElementById('generate-page-btn').addEventListener('click', saveProduct);
      document.getElementById('variants-container').addEventListener('input', updatePricingTable);
      document.getElementById('links-list').addEventListener('click', handleDeleteClick);
      document.getElementById('export-btn').addEventListener('click', exportPages);
      document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-input').click());
      document.getElementById('import-input').addEventListener('change', importPages);
    }

    function populateCategories() {
      const catSelect = document.getElementById('category-select');
      catSelect.innerHTML = '<option value="">-- Select Category --</option>';
      for (const category in productsData.categories) {
        catSelect.innerHTML += `<option value="${category}">${category}</option>`;
      }
    }

    function populateSubcategories() {
      const catSelect = document.getElementById('category-select');
      const subcatSelect = document.getElementById('subcategory-select');
      const selectedCategory = catSelect.value;
      const subcategories = productsData.categories[selectedCategory] || [];
      subcatSelect.innerHTML = '<option value="">-- Select Subcategory --</option>';
      subcategories.forEach(sub => {
        subcatSelect.innerHTML += `<option value="${sub}">${sub}</option>`;
      });
    }

    let variantCount = 0;
    function addVariantBlock() {
      variantCount++;
      const div = document.createElement('div');
      div.className = 'variant-block';
      div.innerHTML = `
        <h4>Variant Type ${variantCount}</h4>
        <input type="text" class="variant-name" placeholder="e.g., Color, Size">
        <input type="text" class="variant-options" placeholder="e.g., Red, Blue, Green (comma-separated)">
      `;
      document.getElementById('variants-container').appendChild(div);
    }

    function getVariantCombinations() {
      const variantNodes = document.querySelectorAll('.variant-block');
      if (variantNodes.length === 0) return [];

      const variants = Array.from(variantNodes).map(node => {
        const options = node.querySelector('.variant-options').value.split(',').map(o => o.trim()).filter(Boolean);
        return options;
      }).filter(v => v.length > 0);

      if (variants.length === 0) return [];

      return variants.reduce((a, b) => a.flatMap(x => b.map(y => `${x}-${y}`)));
    }

    function updatePricingTable() {
      const combinations = getVariantCombinations();
      const pricingContainer = document.getElementById('pricing-container');
      pricingContainer.innerHTML = combinations.length > 0 ? '<h4>Set Price for Each Combination</h4>' : '';
      combinations.forEach(combo => {
        pricingContainer.innerHTML += `
          <div>
            <label for="price-${combo}">${combo}</label>
            <input type="number" id="price-${combo}" data-combo="${combo}" class="price-input" placeholder="Price (‚Çπ)">
            <input type="number" id="discount-${combo}" data-combo="${combo}" class="discount-input" placeholder="Discounted Price (Optional)">
          </div>
        `;
      });
    }

    function saveProduct() {
      const newPageId = Gun.SEA.random(16).toString('hex');
      const productData = {
        id: newPageId,
        name: document.getElementById('product-name').value,
        details: document.getElementById('product-details').value,
        category: document.getElementById('category-select').value,
        subcategory: document.getElementById('subcategory-select').value,
        images: document.getElementById('slider-images').value.split(',').map(url => url.trim()).filter(Boolean)
      };

      const variants = [];
      document.querySelectorAll('.variant-block').forEach(node => {
        variants.push({
          name: node.querySelector('.variant-name').value,
          options: node.querySelector('.variant-options').value.split(',').map(o => o.trim()).filter(Boolean)
        });
      });

      const pricing = {};
      document.querySelectorAll('.price-input').forEach(input => {
        const combo = input.dataset.combo;
        const discountedInput = document.querySelector(`.discount-input[data-combo="${combo}"]`);
        pricing[combo] = {
          price: parseFloat(input.value) || 0,
          discounted: parseFloat(discountedInput.value) || null
        };
      });

      gun.get(newPageId).put(productData);
      gun.get(newPageId).get('variants').put(JSON.stringify(variants));
      gun.get(newPageId).get('pricing').put(JSON.stringify(pricing));
      gun.get('products_index').set(gun.get(newPageId));

      alert(`Page created! ID: ${newPageId}`);
      displayLinks();
    }

    function displayLinks() {
      const listContainer = document.getElementById('links-list');
      if (!listContainer) return;
      listContainer.innerHTML = '';
      gun.get('products_index').map().once((product, id) => {
        if (product && product.name) {
          const link = `app.html?id=${id}`;
          const div = document.createElement('div');
          div.className = 'link-item';
          div.innerHTML = `
            <span>${product.name}</span><br>
            <a href="${link}" target="_blank">${link}</a>
            <button class="delete-btn" data-id="${id}">Delete</button>
          `;
          listContainer.appendChild(div);
        }
      });
    }

    function handleDeleteClick(event) {
      if (event.target.classList.contains('delete-btn')) {
        const idToDelete = event.target.dataset.id;
        if (confirm('Are you sure you want to delete this page? This cannot be undone.')) {
          gun.get(idToDelete).put(null);
          gun.get('products_index').get(idToDelete).put(null);
          event.target.closest('.link-item').remove();
        }
      }
    }

    function loadProductData(id) {
      gun.get(id).once(data => {
        if (!data) {
          appRoot.innerHTML = `<div class="container"><h1>Page not found or deleted.</h1></div>`;
          return;
        }
        document.title = data.name;
        document.getElementById('product-name').innerText = data.name;
        document.getElementById('product-details').innerText = data.details;
        document.getElementById('product-category').innerText = data.category;
        document.getElementById('product-subcategory').innerText = data.subcategory;

        const slider = document.getElementById('image-slider');
        if (data.images && data.images.length > 0) {
          slider.innerHTML = `<img src="${data.images[0]}" alt="${data.name}">`;
        } else {
          slider.innerHTML = '<p>No images available</p>';
        }

        gun.get(id).get('variants').once(variantsStr => {
          gun.get(id).get('pricing').once(pricingStr => {
            const variants = variantsStr ? JSON.parse(variantsStr) : [];
            const pricing = pricingStr ? JSON.parse(pricingStr) : {};
            renderVariantSelectors(variants, pricing);
          });
        });
      });
    }

    function renderVariantSelectors(variants, pricing) {
      const container = document.getElementById('variant-selectors');
      container.innerHTML = '';
      if (!variants || variants.length === 0) {
        const defaultPrice = pricing[''] || { price: 0, discounted: null };
        updatePriceDisplay(defaultPrice.price, defaultPrice.discounted);
        return;
      }

      variants.forEach((variant, index) => {
        let optionsHtml = variant.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        container.innerHTML += `
          <label>${variant.name}</label>
          <select class="variant-select" data-index="${index}">
            ${optionsHtml}
          </select>
        `;
      });

      const updatePrice = () => {
        const selectedOptions = Array.from(document.querySelectorAll('.variant-select')).map(sel => sel.value);
        const comboKey = selectedOptions.join('-');
        const priceInfo = pricing[comboKey] || { price: 'N/A', discounted: null };
        updatePriceDisplay(priceInfo.price, priceInfo.discounted);
      };

      document.querySelectorAll('.variant-select').forEach(sel => sel.addEventListener('change', updatePrice));
      updatePrice();
    }

    function updatePriceDisplay(price, discounted) {
      const priceEl = document.getElementById('product-price');
      if (discounted && discounted < price) {
        priceEl.innerHTML = `<del>‚Çπ${price}</del> <strong>‚Çπ${discounted}</strong>`;
      } else {
        priceEl.innerHTML = `<strong>‚Çπ${price}</strong>`;
      }
    }

    function exportPages() {
      const allData = {};
      gun.get('products_index').map().once((product, id) => {
        if (!product || !id) return;
        gun.get(id).once(data => {
          gun.get(id).get('variants').once(variants => {
            gun.get(id).get('pricing').once(pricing => {
              allData[id] = {
                ...data,
                variants,
                pricing
              };
              if (Object.keys(allData).length > 0) {
                const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'pages_backup.json';
                a.click();
              }
            });
          });
        });
      });
    }

    function importPages(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = JSON.parse(e.target.result);
        for (const id in data) {
          const entry = data[id];
          gun.get(id).put({
            id,
            name: entry.name,
            details: entry.details,
            category: entry.category,
            subcategory: entry.subcategory,
            images: entry.images
          });
          gun.get(id).get('variants').put(entry.variants);
          gun.get(id).get('pricing').put(entry.pricing);
          gun.get('products_index').set(gun.get(id));
        }
        alert('Pages imported successfully!');
        displayLinks();
      };
      reader.readAsText(file);
    }

  });
 
  // --- üîí ENSURE DATA SAVING FOR DYNAMIC PAGES ---
    function saveFullPageDataWithIntegrity() {
      const newPageId = Gun.SEA.random(16).toString('hex');
      const product = {
        id: newPageId,
        name: document.getElementById('product-name').value,
        details: document.getElementById('product-details').value,
        category: document.getElementById('category-select').value,
        subcategory: document.getElementById('subcategory-select').value,
        images: document.getElementById('slider-images').value.split(',').map(s => s.trim()).filter(Boolean)
      };

      if (!product.name || !product.details) {
        alert("Please fill in all product details.");
        return;
      }

      const variants = [];
      document.querySelectorAll('.variant-block').forEach((block) => {
        const name = block.querySelector('.variant-name').value;
        const options = block.querySelector('.variant-options').value
          .split(',')
          .map(o => o.trim())
          .filter(Boolean);
        if (name && options.length) {
          variants.push({ name, options });
        }
      });

      const pricing = {};
      document.querySelectorAll('.price-input').forEach((priceInput) => {
        const combo = priceInput.dataset.combo;
        const discountedInput = document.querySelector(`.discount-input[data-combo="${combo}"]`);
        pricing[combo] = {
          price: parseFloat(priceInput.value) || 0,
          discounted: parseFloat(discountedInput?.value || '') || null
        };
      });

      // Put main product data
      gun.get(newPageId).put(product);

      // Store variants & pricing as structured JSON
      gun.get(newPageId).get('variants').put(JSON.stringify(variants));
      gun.get(newPageId).get('pricing').put(JSON.stringify(pricing));

      // Store a timestamp & hash for validation/debugging
      const timestamp = Date.now();
      gun.get(newPageId).get('timestamp').put(timestamp);
      Gun.SEA.work(JSON.stringify(product), null, null, (hash) => {
        gun.get(newPageId).get('hash').put(hash);
      });

      // Index for listing
      gun.get('products_index').set(gun.get(newPageId));

      alert(`‚úîÔ∏è Page saved: ${newPageId}`);
      displayLinks();
    }

    // Optional override old generate button with secure version
    const generateBtn = document.getElementById('generate-page-btn');
    if (generateBtn) {
      generateBtn.removeEventListener('click', saveProduct); // remove if exists
      generateBtn.addEventListener('click', saveFullPageDataWithIntegrity);
        }
                </script>
</body>
</html>
